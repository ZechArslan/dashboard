<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transactions</title>
    <link rel="stylesheet" href="daterangepicker.css" />
    <!-- <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" /> -->
    <link rel="stylesheet" href="datatables.min.css" />
    <link rel="stylesheet" href="style.css?v=223343" />
    <link rel="stylesheet" href="Styles-c.css?v=1" />
    <link href="dist/css/select2.min.css" rel="stylesheet" />

    <style>
      div#viewTrade-Modal-pnl div.dt-buttons,
      div#viewTrade-Modal div.dt-buttons {
        padding-right: 0;
      }

      /* #111111 */
      .statsinfo {
        font-size: 14px;
        color: white;
        display: flex;
        gap: 30px;
      }

      .statsinfo span {
        display: inline-block;
      }

      .statsinfo .dot {
        min-width: 6px;
        min-height: 6px;
        background-color: rgb(224, 224, 224);
        border-radius: 100%;
      }

      .sBlockCont {
        display: flex;
        align-items: center;
      }

      div#viewTrade-Modal .dataTables_wrapper .dataTables_filter {
        display: flex !important;
        margin-left: 10px;
        font-size: 14px;
        font-family: "Poppins";
        display: flex;
        align-items: center;
        background-color: #222222;
        height: 40px;
        border-radius: 6px;
        color: white;
        border: 1px solid white;
        opacity: 0.2;
        transition: opacity 0.3s ease-in-out;
      }

      div#viewTrade-Modal .dataTables_wrapper .dataTables_filter:hover {
        opacity: 0.8;
      }

      div#viewTrade-Modal .dataTables_wrapper .dataTables_filter input {
        border: none;
        color: white;

        height: 40px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- <div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word; ">
        91208091248120948091248094218098212098049128092180492480921809820981810912480912480
      </div> -->

      <span id="${id}" class="homeTableAddress"></span>
      <div class="top_buttons">
        <span>P&L Dashboard</span>
        <button id="export-all" class="dt-button download-btn">
          <img src="./arrow.png" width="17" height="17" alt="D" />
          <span> Export All </span>
        </button>
      </div>
      <div class="card">
        <!-- <div class="title-head">
                <h2>Lemuria</h2>
            </div> -->
        <!-- <div class="button-sett">
          <div class="feild-set1">
            <fieldset class="cust-feld-st">
              <img src="./search.svg" width="24" height="24" alt="" />
              <input
                class="token-pnl"
                placeholder="Token Address"
                id="pnl-input-address"
                type="text"
              />
            </fieldset>
          </div>
   
        </div> -->
        <div class="statsinfo startBlockEnd">
          <span class="sBlockCont">
            <span class="dot"></span>
            <span>Starting Block:</span>
            <b id="sblock">0</b>
          </span>
          <span class="sBlockCont">
            <span class="dot"></span>
            <span>Ending Block:</span>
            <b id="eblock">0</b>
          </span>
        </div>
        <div class="date-range">
          <input id="daterangeval" type="text" name="daterange" value="" />
        </div>

        <table id="dt_table" class="display" style="width: 100%">
          <thead>
            <tr>
              <th class="trDataClss">Address</th>
              <th>Total P&L</th>
              <th>Realized Pnl</th>
              <th>UnRealized Pnl</th>
              <th>TxCount</th>
              <!-- <th>Transfer Value</th> -->
              <th>Action</th>
            </tr>
          </thead>

          <tfoot>
            <tr>
              <th>Address</th>
              <th>Total P&L</th>
              <th>Realized Pnl</th>
              <th>UnRealized Pnl</th>
              <th>TxCount</th>
              <!-- <th>Transfer Value</th> -->
              <th>Action</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <!-- modal 1 -->
    <div id="viewTrade-Modal" class="modal modal-summary viewTrade-Modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="title-head">
            <h2>Trades: <a class="address11" href="#" target="_blank"></a></h2>
          </div>
          <div class="cross-svg">
            <span><img src="cross-coin.svg" alt="" /></span>
          </div>
          <table id="dt_mtable" class="display dataTable" style="width: 100%">
            <thead>
              <tr>
                <th>Address</th>
                <th>TxID</th>
                <th title="From Token">From</th>
                <th title="To Token">To</th>
                <th>From Amount</th>
                <th>To Amount</th>
                <th>$From Amount</th>
                <th>$To Amount</th>
                <th title="PNL USD">P&L</th>
                <th>P&L ETH</th>
                <th>Date</th>
                <th>Price</th>
              </tr>
            </thead>
            <tfoot>
              <tr>
                <th>Address</th>
                <th>TxID</th>
                <th title="From Token">From</th>
                <th title="To Token">To</th>
                <th>From Amount</th>
                <th>To Amount</th>
                <th>$From Amount</th>
                <th>$To Amount</th>
                <th title="PNL USD">P&L</th>
                <th>P&L ETH</th>
                <th>Date</th>
                <th>Price</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    <!-- modal 2 -->
    <div
      id="viewTrade-Modal-pnl"
      class="modal modal-summary viewTrade-Modal-pnl"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="title-head">
            <h2>PNL <a class="address11" href="#" target="_blank"></a></h2>
          </div>
          <div class="cross-svg">
            <span><img src="cross-coin.svg" alt="" /></span>
          </div>
          <table id="dt_mtable_pnl" class="display" style="width: 100%">
            <thead>
              <tr>
                <th>Address</th>
                <th>Token</th>
                <th>Bought</th>
                <th>Sold</th>
                <th>Un Sold</th>
                <th>Realized P&L</th>
                <th>UnRealized P&L</th>
                <th>Total P&L</th>
                <!-- <th>Transfer Value</th> -->
                <th>TradeCount</th>
                <th>Status</th>
                <th>Entry Price</th>
                <th>Exit Price</th>
                <th>Entry Date</th>
                <th>Exit Date</th>
              </tr>
            </thead>

            <tfoot>
              <tr>
                <th>Address</th>
                <th>Token</th>
                <th>Bought</th>
                <th>Sold</th>
                <th>Un Sold</th>
                <th>Realized P&L</th>
                <th>UnRealized P&L</th>
                <th>Total P&L</th>
                <!-- <th>Transfer Value</th> -->
                <th>TradeCount</th>
                <th>Status</th>
                <th>Entry Price</th>
                <th>Exit Price</th>
                <th>Entry Date</th>
                <th>Exit Date</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal 3 -->
    <div class="edit-trade-modal modal modal-summary" id="edit-trade-modal">
      <div class="edit-modal-dialog">
        <div class="modal-content">
          <div class="addTagField">
            <select
              id="mySelect"
              class="js-example-tags"
              multiple="multiple"
              style="width: 80%"
            ></select>
            <div>
              <button class="addTag" id="addTag">Add Tag</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="jquery-3.6.0.min.js"></script>
    <script src="datatables.min.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/plug-ins/1.11.5/api/sum().js"
    ></script>
    <script type="text/javascript" src="moment.min.js"></script>
    <script type="text/javascript" src="daterangepicker.js"></script>
    <script src="buttons.colVis.min.js"></script>
    <script src="dist/js/select2.min.js"></script>

    <!-- <script src="package.js"></script> -->

    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script> -->
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script> -->

    <script>
      $(document).ready(function () {
        $.post(
          "http://144.76.163.123/dashboard/datatable.php",
          {
            blocks: true,
          },
          function (data, status) {
            // data = JSON.parse(data);
            // console.log(data,);
            $("#sblock").html(data[0]);
            $("#eblock").html(data[1]);
            // alert("Data: " + data + "\nStatus: " + status);
          }
        );
        var dataRange = [false, true, true, true, true, false];
        var Api;
        var datestart = "";
        var dateend = "";
        $('input[name="daterange"]').on(
          "cancel.daterangepicker",
          function (ev, picker) {
            // $('input[name="daterange"]').daterangepicker({ startDate: '11/10/2022', endDate: '11/10/2022' });
            $(this)
              .data("daterangepicker")
              .setStartDate(moment().format("MM-DD-YYYY")); //date now
            $(this)
              .data("daterangepicker")
              .setEndDate(moment().format("MM-DD-YYYY")); //date now
            datestart = "";
            dateend = "";
          }
        );
        var startt = "04/15/2022";
        // var endt = '11/15/2022'
        var enddt = new Date();
        var endt =
          enddt.getMonth() +
          1 +
          "/" +
          enddt.getDate() +
          "/" +
          enddt.getFullYear();
        console.log("endt", endt);
        $('input[name="daterange"]').daterangepicker(
          {
            opens: "left",
            dateFormat: "dd/mm/yy",
            // startDate:  startt, //moment(),
            // endDate: endt, //moment().add(20, 'day'),
            minDate: startt, // moment(),
            maxDate: endt, // moment().add(20, 'day'),
          },
          function (start, end, label) {
            datestart = start.format("YYYY-MM-DD");
            dateend = end.format("YYYY-MM-DD");

            // $(this).data('daterangepicker').setStartDate(startt); //date now
            // $(this).data('daterangepicker').setEndDate(endt);//date now
            console.log(
              "A new date selection was made: " +
                start.format("YYYY-MM-DD") +
                " to " +
                end.format("YYYY-MM-DD")
            );
          }
        );
        const currentDate = new Date();
        const formattedDate = currentDate.toLocaleDateString("en-US", {
          month: "2-digit",
          day: "2-digit",
          year: "numeric",
        });
        // console.log(formattedDate);
        $('input[name="daterange"]')
          .data("daterangepicker")
          .setStartDate(moment("04/15/2022").format("MM-DD-YYYY")); //date now
        $('input[name="daterange"]')
          .data("daterangepicker")
          .setEndDate(moment(formattedDate).format("MM-DD-YYYY")); //date now

        $("#dt_table thead tr")
          .clone(true)
          .addClass("filters")
          .appendTo("#dt_table thead");

        var table = $("#dt_table").DataTable({
          orderCellsTop: true,
          scrollX: true,
          // ajax: 'data/objects.json',
          processing: true,
          serverSide: true,
          serverMethod: "post",
          oLanguage: { sProcessing: "<div id='loader'></div>" },

          // ajax: '../../datatable.php', ///Path will change here
          ajax: {
            url: "http://144.76.163.123/dashboard/datatable.php",
            data: function (d) {
              d.datestart = datestart;
              d.dateend = dateend;
              window["lastpayload"] = d;
            },
          },
          columns: [
            {
              data: "Address",
              render: (id) => {
                const formattedAddress =
                  id.substr(0, 9) + "..." + id.substr(id.length - 9);

                return `<span id="${id}" class="homeTableAddress" onclick="" >${formattedAddress}</span>`;
              },
            },
            { data: "TotalPNL" },
            { data: "RealizedPNL" },
            { data: "UnRealizedPNL" },
            { data: "TxCount" },
            // { data: "TransferAmount" },
            {
              data: "Address",
              render: function (e) {
                return `
                <div class="eatherIconcontainer">
                    <abbr title="link:0x89s">
                        <div
                        class="eatherIcon actionsIcons tradeAddressTab"
                        id="${e}"
                        width="20px"
                        height="20px"
                        type="button"
                        onclick="viewEather(${e})"
                        >
                        <img src="./ethereum.svg" alt="" />
                        </div>
                    </abbr>
                    <abbr title="View Trade">
                        <div class="eyesIcons actionsIcons u-btn"  type="button">
                        <img src="./view.png" alt="" />
                        </div>
                    </abbr>
                    <abbr title="View PNL">
                        <div class="eyesIcons actionsIcons earthIcon pnl-btn" width="20px" height="20px" type="button">
                        <img src="./stats.svg" alt="" />
                        </div>
                    </abbr>
                    <abbr title="View PNL">
                        <div class="statisIcon actionsIcons earthIcon edit-modal" width="20px" height="20px" type="button" id="${e}">
                        <img src="./edit.png" alt="" />
                        </div>
                    </abbr>
                </div> `;
              },
            },
          ],
          dom: "Blfrtip",
          buttons: [
            {
              extend: "csv",
              exportOptions: {
                columns: [0, 1, 2, 3, 4],
              },
              title: "CSV File",
            },
            "excel",
            "pdf",
          ],

          stateSave: true,
          // fixedHeader: {
          //     headerOffset: 40
          // },
          stateSaveParams: function (settings, data) {
            data.search.search = "";
            // data.search.datestart = datestart;
            // data.search.dateend = dateend;
            data.columns.forEach((val) => {
              val.search.search = "";
            });
          },
          columnDefs: [
            { targets: 0, orderable: false, searching: false, width: "10%" },
            { width: "10%", targets: 1 },
            { width: "10%", targets: 2 },
            { width: "10%", targets: 3 },
            { width: "10%", targets: 4 },
            // { width: "10%", targets: 5 },
            { width: "10%", targets: 5, orderable: false },
          ],
          language: {
            lengthMenu: "_MENU_",
          },
          lengthMenu: [
            [5, 10, 25, 50, 100, 500],
            [5, 10, 25, 50, 100, 500],
          ],
          pageLength: 10,

          initComplete: function () {
            var api = this.api();
            Api = this.api();

            // For each column
            api
              .columns()
              .eq(0)
              .each(function (colIdx) {
                if (colIdx != 6) {
                  var cell = $(".filters th").eq(
                    $(api.column(colIdx).header()).index()
                  );
                  var title = $(cell).text();

                  if (dataRange[colIdx]) {
                    $(cell).html(`<div class="mminput">
                                    <input class="rangeinput" type="text" placeholder="${title}" />
                                    <input class="mininput" type="text" placeholder="Min" />
                                    <input class="maxinput" type="text" placeholder="Max" /></div>`);
                  } else {
                    $(cell).html(
                      '<input type="text" placeholder="' + title + '" />'
                    );
                  }
                }
                // $('input',$('.filters th').eq($(api.column(colIdx).header()).index()))
                //     .off('keyup change')
                //     .on('change', function (e) {

                //         $(this).attr('title', $(this).val());
                //         var regexr = '({search})';
                //         var cursorPosition = this.selectionStart;
                //         api
                //             .column(colIdx)
                //             .search(this.value)
                //             .draw();
                //     })
                //     .on('keyup', function (e) {
                //         e.stopPropagation();
                //     });
              });
          },
        });

        table.button().add(1, {
          action: function (e, dt, button, config) {
            var tableid = button.attr("aria-controls");
            $.fn.dataTable.ext.search = [];

            Api.columns()
              .eq(0)
              .each(function (colIdx) {
                var inputVal = $(".filters th")
                  .eq($(Api.column(colIdx).header()).index())
                  .find("input")
                  .val();
                Api.column(colIdx).search(inputVal);
              });
            dt.draw();
          },
          text: "Search",
          className: "search-btnTbl",
        });

        $("body").on("input", ".mininput", function () {
          var maxData = $(this).closest(".mminput").find(".maxinput").val();
          var val = $(this).val() + ",," + maxData;
          if (val.length <= 2) {
            val = "";
          }
          $(this).closest(".mminput").find(".rangeinput").val(val);
        });

        $("body").on("input", ".maxinput", function () {
          var minData = $(this).closest(".mminput").find(".mininput").val();
          var val = minData + ",," + $(this).val();
          if (val.length <= 2) {
            val = "";
          }
          $(this).closest(".mminput").find(".rangeinput").val(val);
        });

        let table112 = null;
        let tablepnl = null;
        var tablehtml = $("#viewTrade-Modal .modal-content").html();
        var tablehtml_pnl = $("#viewTrade-Modal-pnl .modal-content").html();
        var editPopup_bach = $("#edit-trade-modal .modal-content").html();
        $("body").on("click", ".u-btn", function () {
          $("body").addClass("oflowhidden");

          var thSearchStatus = [
            false,
            true,
            true,
            true,
            false,
            false,
            false,
            false,
            false,
            false,
            false,
            false,
          ];

          if ($.fn.DataTable.isDataTable("#dt_mtable")) {
            if (table112 != null) {
              table112.clear().destroy();
              $("#viewTrade-Modal .modal-content").html(tablehtml);
              // $('#dt_mtable').dataTable().clear().destroy();
            }
          }

          $(".viewTrade-Modal, .modal-backdrop").addClass("show");
          var rowAddress = $(this).closest("tr").find("td span").attr("id");

          var address = rowAddress.match(/(0x[a-fA-F0-9]{40})/)[1];

          $(".address11").attr(
            "href",
            "https://etherscan.io/address/" + address
          );
          $(".address11").text(address);

          $("#dt_mtable thead tr")
            .clone(true)
            .addClass("filter")
            .appendTo("#dt_mtable thead");

          table112 = $("#dt_mtable").DataTable({
            orderCellsTop: true,
            serverMethod: "post",
            scrollX: true,
            ajax: {
              url: "http://144.76.163.123/dashboard/popup.php",
              data: function (d) {
                d.address = address;
                d.datestart = datestart;
                d.dateend = dateend;
              },
            },
            // render: (id) => {
            //     false;
            //     const formattedAddress =
            //       id.substr(0, 9) + "..." + id.substr(id.length - 9);

            //     return `<span id="${id}" class="homeTableAddress" onclick="" >${formattedAddress}</span>`;
            //   },
            columns: [
              { defaultContent: address },
              { data: "TID" },
              {
                data: "FTOKEN",
                render: function (data) {
                  const timestamp = new Date().getTime();
                  var range = document.createRange();
                  var fragment = range.createContextualFragment(data);
                  var textData = fragment.firstElementChild.innerHTML;
                  var linkdata =
                    fragment.firstElementChild.getAttribute("href");
                  var filtredStrings =
                    textData.length > 30
                      ? textData.substring(0, 20) +
                        "..." +
                        textData.substring(textData.length - 1)
                      : textData;
                  return `<div  class="tradePopUpFields">
                    <span class='viewMoreContent' id='${
                      textData + "*$" + timestamp
                    }'>${filtredStrings}</span>
                  <a href="${linkdata}" target="_blank" class="appendImage"><img src="./open.png" alt="Image Alt Text" class="openInnewTab"/></a>
                  </div>`;
                },
              },
              {
                data: "TOTOKEN",
                render: function (data) {
                  const timestamp = new Date().getTime();
                  var range = document.createRange();
                  var fragment = range.createContextualFragment(data);
                  var textData = fragment.firstElementChild.innerHTML;
                  var linkdata =
                    fragment.firstElementChild.getAttribute("href");
                  var filtredStrings =
                    textData.length > 30
                      ? textData.substring(0, 20) +
                        "..." +
                        textData.substring(textData.length - 1)
                      : textData;
                  return `<div  class="tradePopUpFields">
                    <span class='viewMoreContent' id='${
                      textData + "*$" + timestamp
                    }'>${filtredStrings}</span>
                  <a href="${linkdata}" target="_blank" class="appendImage"><img src="./open.png" alt="Image Alt Text" class="openInnewTab"/></a>
                  </div>`;
                },
              },
              {
                data: "FAMOUNT",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;"  >
                    ${data}
                    </div>`;
                },
              },
              {
                data: "TOAMOUNT",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;" >
                    ${data}
                    </div>`;
                },
              },
              {
                data: "FAMOUNTUsd",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;" >
                    ${data}
                    </div>`;
                },
              },
              {
                data: "TOAMOUNTUsd",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;" >
                    ${data}
                    </div>`;
                },
              },
              {
                data: "PNLUSD",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;">
                    ${data}
                    </div>`;
                },
              },
              {
                data: "PNLETH",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;">
                    ${data}
                    </div>`;
                },
              },
              {
                data: "TDATEID",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;">
                    ${data}
                    </div>`;
                },
              },
              {
                data: "PRICE",
                render: function (data) {
                  return `<div style="max-width: 100px; word-wrap: break-word; overflow-wrap: break-word;">
                    ${data}
                    </div>`;
                },
              },
            ],

            // dom: 'Blfrtip',
            //     buttons: [
            //     'csv'
            // ],

            dom: "flBrtip",
            buttons: [
              {
                extend: "colvis",
                text: "Show/Hide Columns",
              },
              {
                extend: "csv",
                title: "Trade-" + address,
              },
            ],
            stateSave: true,
            stateSaveParams: function (settings, data) {
              data.search.search = "";
              data.columns.forEach((val) => {
                val.search.search = "";
              });
            },
            columnDefs: [
              { targets: 0, visible: false },
              { targets: 1, orderable: false, searching: false },
            ],
            language: {
              lengthMenu: "_MENU_",
              search: `<img src="./search.png" width="24" height="24" alt=""  /> _INPUT_`,
              // searchPlaceholder: "Search..."
            },

            lengthMenu: [
              [5, 10, 25, 50, 100, 500],
              [5, 10, 25, 50, 100, 500],
            ],
            pageLength: 10,
            initComplete: function () {
              var api = this.api();
              api
                .columns()
                .eq(0)
                .each(function (colIdx) {
                  var cell = $(".filter th").eq(
                    $(api.column(colIdx).header()).index()
                  );
                  var title = $(cell).text();

                  if (thSearchStatus[colIdx]) {
                    $(cell).html(
                      '<input type="text" placeholder="' + title + '" />'
                    );
                  } else {
                    $(cell).html("");
                  }

                  $(
                    "input",
                    $(".filter th").eq($(api.column(colIdx).header()).index())
                  )
                    .off("keyup change")
                    .on("keyup change", function (e) {
                      $(this).attr("title", $(this).val());
                      var regexr = "({search})";
                      var cursorPosition = this.selectionStart;

                      api.column(colIdx).search(this.value).draw();
                    })
                    .on("keyup", function (e) {
                      e.stopPropagation();
                    });
                });
            },
            drawCallback: function () {
              var api = this.api();
              var sum = {};
              var formated = 0;

              $(api.column(0).footer()).html("Total");

              for (var i = 6; i <= 8; i++) {
                // if (i === 7) { continue; }

                if (sum[i] == undefined) sum[i] = 0;
                const apiData = api.column(i, { page: "current" }).data();

                for (var j = 0; j < apiData.length; j++) {
                  var dt = apiData[j];
                  if (dt) {
                    dt = Number(dt.replace(/[$]/g, ""));
                    if (!isNaN(dt)) {
                      sum[i] += parseFloat(dt);
                    }
                  }
                }

                // formated = parseFloat(sum).toLocaleString(undefined, {minimumFractionDigits:2});
                let total = CICS(sum[i], i);
                console.log(total, "THIS IS TOTAL cic.--->");

                dsign = "";
                if (i !== 8) {
                  dsign = "$";
                }
                $(api.column(i).footer()).html(
                  total.indexOf("-") > -1
                    ? "-" + dsign + total.substring(1, total.length)
                    : dsign + total
                );
              }
            },
          });
        });
        $("#dt_table").on("click", ".tradeAddressTab", function (e) {
          window.open(
            `https://etherscan.io/address/${e.currentTarget.id}`,
            "_blank"
          );
        });
        $("#dt_table").on("click", ".homeTableAddress", function (e) {
          e.currentTarget.innerHTML.toString().includes("...")
            ? (e.currentTarget.innerHTML = e.currentTarget.id)
            : (e.currentTarget.innerHTML =
                e.currentTarget.id.substr(0, 9) +
                "..." +
                e.currentTarget.id.substr(e.currentTarget.id.length - 9));
        });

        $("#dt_mtable").on("click", ".viewMoreContent", function (e) {
          if (e.currentTarget.innerHTML.length > 23) {
            let strIndex = e.currentTarget.id.indexOf("*$");
            let actutalString = e.currentTarget.id.slice(0, strIndex);

            e.currentTarget.innerHTML.toString().includes("...")
              ? (e.currentTarget.innerHTML = actutalString)
              : (e.currentTarget.innerHTML =
                  e.currentTarget.innerHTML.substring(0, 20) +
                  "..." +
                  e.currentTarget.innerHTML.substring(
                    e.currentTarget.innerHTML.length - 1
                  ));
          }
        });
        // $('body').on('click', '.dt-button-collection .dt-button', function () {
        //     setTimeout(() => {
        //         $('#dt_mtable').DataTable().columns.adjust()
        //     }, 1000)

        // });

        $("body").on("click", ".pnl-btn", function () {
          var thSearchStatus = [
            false,
            true,
            false,
            false,
            false,
            false,
            false,
            false,
            true,
            false,
            false,
            false,
            false,
          ];

          if ($.fn.DataTable.isDataTable("#dt_mtable_pnl")) {
            if (tablepnl != null) {
              tablepnl.clear().destroy();
              $("#viewTrade-Modal-pnl .modal-content").html(tablehtml_pnl);
              // $('#dt_mtable_pnl').dataTable().clear().destroy();
            }
          }

          $("body").addClass("oflowhidden");
          $(".viewTrade-Modal-pnl").toggleClass("show");

          var rowAddress = $(this).closest("tr").find("td span").attr("id");
          var address = rowAddress.match(/(0x[a-fA-F0-9]{40})/)[1];

          $(".address11").attr(
            "href",
            "https://etherscan.io/address/" + address
          );
          $(".address11").text(address);

          $("#dt_mtable_pnl thead tr")
            .clone(true)
            .addClass("filter1")
            .appendTo("#dt_mtable_pnl thead");

          tablepnl = $("#dt_mtable_pnl").DataTable({
            orderCellsTop: true,
            serverMethod: "post",
            scrollX: true,
            autoWidth: false,
            ajax: {
              url: "http://144.76.163.123/dashboard/pnl.php",
              data: function (d) {
                d.address = address;
                d.datestart = datestart;
                d.dateend = dateend;
              },
            },
            columns: [
              { defaultContent: address },
              {
                data: "Token",
                render: (data) => {
                  return `<div class="tradePanelPopUp">${data}</div>`;
                },
              },
              {
                data: "Bought",
                render: (data) => {
                  return `<div class="tradePopUpFields">${data}</div>`;
                },
              },
              {
                data: "Sold",
                render: (data) => {
                  return `<div class="tradePopUpFields">${data}</div>`;
                },
              },
              {
                data: "UnSold",
                render: (data) => {
                  return `<div class="tradePopUpFields">${data}</div>`;
                },
              },
              {
                data: "RealizedPNL",
                render: (data) => {
                  return `<div class="tradePopUpFields">${data}</div>`;
                },
              },
              {
                data: "UnRealizedPNL",
                render: (data) => {
                  return `<div class="tradePopUpFields">${data}</div>`;
                },
              },
              {
                data: "TotalPNL",
                render: (data) => {
                  return `<div class="tradePopUpFields">${data}</div>`;
                },
              },
              // { data: "TransfersPNL" },
              {
                data: "TradeCount",
                render: (data) => {
                  return `<div style="max-width: 60px; word-wrap: break-word; overflow-wrap: break-word;">${data}</div>`;
                },
              },
              {
                data: "Status",
                render: (data) => {
                  return `<div style="max-width: 60px; word-wrap: break-word; overflow-wrap: break-word;">${data}</div>`;
                },
              },
              {
                data: "Entry",
                render: (data) => {
                  return `<div style="max-width: 60px; word-wrap: break-word; overflow-wrap: break-word;">${data}</div>`;
                },
              },
              {
                data: "Exit",
                render: (data) => {
                  return `<div style="max-width: 60px; word-wrap: break-word; overflow-wrap: break-word;">${data}</div>`;
                },
              },
              {
                data: "StartDate",
                render: (data) => {
                  return `<div style="max-width: 60px; word-wrap: break-word; overflow-wrap: break-word;">${data}</div>`;
                },
              },
              {
                data: "EndDate",
                render: (data) => {
                  return `<div style="max-width: 60px; word-wrap: break-word; overflow-wrap: break-word;">${data}</div>`;
                },
              },
            ],
            dom: "Blfrtip",
            buttons: [
              {
                extend: "csv",
                title: "PNL-" + address,
              },
            ],
            stateSave: true,
            stateSaveParams: function (settings, data) {
              data.search.search = "";
              data.columns.forEach((val) => {
                val.search.search = "";
              });
            },
            columnDefs: [
              { targets: 0, visible: false },
              { targets: 1, orderable: false, searching: false },
            ],
            language: {
              lengthMenu: "_MENU_",
            },
            lengthMenu: [
              [5, 10, 25, 50, 100, 500],
              [5, 10, 25, 50, 100, 500],
            ],
            pageLength: 10,
            initComplete: function () {
              var api = this.api();
              api
                .columns()
                .eq(0)
                .each(function (colIdx) {
                  var cell = $(".filter1 th").eq(
                    $(api.column(colIdx).header()).index()
                  );
                  var title = $(cell).text();

                  if (thSearchStatus[colIdx]) {
                    $(cell).html(
                      '<input type="text" placeholder="' + title + '" />'
                    );
                  } else {
                    $(cell).html("");
                  }

                  $(
                    "input",
                    $(".filter1 th").eq($(api.column(colIdx).header()).index())
                  )
                    .off("keyup change")
                    .on("keyup change", function (e) {
                      $(this).attr("title", $(this).val());
                      var regexr = "({search})";
                      var cursorPosition = this.selectionStart;
                      api.column(colIdx).search(this.value).draw();
                    })
                    .on("keyup", function (e) {
                      e.stopPropagation();
                    });
                });

              $("#dt_mtable_pnl_wrapper .sorting:eq(0)").trigger("click");
            },
            drawCallback: function () {
              var api = this.api();
              var sum = 0;
              var formated = 0;

              $(api.column(0).footer()).html("Total");

              for (var i = 2; i <= 8; i++) {
                // if (i === 7) { continue; }
                let sum = api.column(i, { page: "current" }).data().sum();
                if (isNaN(sum))
                  sum = api
                    .column(i, { page: "current" })
                    .data()
                    .map((a) => $(a).text())
                    .sum();
                dsign = "";
                if (i !== 8) {
                  dsign = "$";
                }
                $(api.column(i).footer()).html(
                  dsign +
                    parseFloat(sum).toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                    })
                );
              }
            },
          });
        });

        // This is Edit table

        $("body").on("click", ".edit-modal", function () {
          $("#edit-trade-modal .modal-content").html(editPopup_bach);
          $("body").addClass("oflowhidden");
          $(".edit-trade-modal").toggleClass("show");
          $(".js-example-tags").select2({
            tags: true,
          });
        });
      });

      $("body").on("click keyup", function (e) {
        if (e.keyCode == 27 || e.target == $(".modal.show")[0]) {
          $(".modal.show").removeClass("show");
          $("body").removeClass("oflowhidden");
        }
      });

      function CICS(labelValue, i) {
        // Nine Zeroes for Billions
        console.log(labelValue, i, "labelValue----->");
        if (i == 5)
          console.log(
            "function ",
            Number(labelValue),
            (Number(labelValue) / 1.0e3).toFixed(2)
          );

        if (Number(labelValue) >= 1e12) {
          return (Number(labelValue) / 1e12).toFixed(2) + "<strong>T</strong>";
        }
        return Number(labelValue) >= 1.0e9
          ? (Number(labelValue) / 1.0e9).toFixed(2) + "<strong>B</strong>"
          : // Six Zeroes for Millions
          Number(labelValue) >= 1.0e6
          ? (Number(labelValue) / 1.0e6).toFixed(2) + "<strong>M</strong>"
          : // Three Zeroes for Thousands
          Number(labelValue) >= 1.0e3
          ? (Number(labelValue) / 1.0e3).toFixed(2) + "<strong>K</strong>"
          : Number(labelValue).toFixed(2);
      }

      $("body").on("click", ".viewTrade-Modal .cross-svg", function () {
        $("body").removeClass("oflowhidden");
        $(".viewTrade-Modal, .modal-backdrop").removeClass("show");
      });
      $("body").on("click", ".viewTrade-Modal-pnl .cross-svg", function () {
        $("body").removeClass("oflowhidden");
        $(".viewTrade-Modal-pnl").removeClass("show");
      });

      $("body").on("click", ".edit-trade-modal .cross-svg", function () {
        $("body").removeClass("oflowhidden");
        $(".edit-trade-modal").removeClass("show");
      });

      var hostUrl = "http://144.76.163.123/dashboard"; // = window.location.protocol + "//" + window.location.hostname;
      $("#export-all").on("click", function () {
        // window.open(hostUrl + "/data1/datatable.php?exportcsv=1&data=" + encodeURIComponent(JSON.stringify(window.lastpayload)));
        window.open(
          hostUrl +
            "/dashboard/datatable.php?exportcsv=1&data=" +
            encodeURIComponent(JSON.stringify(window.lastpayload))
        );
      });
      $("#pnl-by-token").on("click", function () {
        const inputval = $("#pnl-input-address").val();
        // window.open(hostUrl + "/data1/pnlbytoken1.php?address="+inputval);
        window.open(hostUrl + "/dashboard/pnlbytoken1.php?address=" + inputval);
      });

      function copyToClipboard(text) {
        if (window.clipboardData && window.clipboardData.setData) {
          // Internet Explorer-specific code path to prevent textarea being shown while dialog is visible.
          return window.clipboardData.setData("Text", text);
        } else if (
          document.queryCommandSupported &&
          document.queryCommandSupported("copy")
        ) {
          var textarea = document.createElement("textarea");
          textarea.textContent = text;
          textarea.style.position = "fixed"; // Prevent scrolling to bottom of page in Microsoft Edge.
          document.body.appendChild(textarea);
          textarea.select();
          try {
            return document.execCommand("copy"); // Security exception may be thrown by some browsers.
          } catch (ex) {
            console.warn("Copy to clipboard failed.", ex);
            return prompt("Copy to clipboard: Ctrl+C, Enter", text);
          } finally {
            document.body.removeChild(textarea);
          }
        }
      }

      var rowAddressTags = null;
      $("body").on("click", ".edit-modal", function (e) {
        rowAddressTags = e.currentTarget.id;
        $.ajax({
          url:
            "http://144.76.163.123/dashboard/address.php?action=get_address_tags&address_id=" +
            rowAddressTags,
          method: "GET",
          dataType: "json",
          success: function (data) {
            var select = $("#mySelect");
            select.empty();

            data.forEach(function (option) {
              select.append(new Option(option, option, false, false));
            });

            select.select2({
              tags: true,
            });
            var allOptions = data.map(function (option) {
              return option;
            });
            select.val(allOptions).trigger("change");
          },
          error: function (xhr, status, error) {
            alert(error);
          },
        });
      });

      $("body").on("click", ".addTag", function () {
        var selectedTags = $("#mySelect").val();
        var jsonData = JSON.stringify(selectedTags);
        $.ajax({
          url:
            "http://144.76.163.123/dashboard/address.php?action=update_address_tags&address_id=" +
            rowAddressTags,
          method: "POST",

          data: $.param({ tags: jsonData }),
          dataType: "json",
          success: function (data) {
            alert(data);
          },
          error: function (xhr, status, error) {
            alert(error);
          },
        });
      });
    </script>
  </body>
</html>
